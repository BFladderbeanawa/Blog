"use strict";var he=Object.defineProperty;var ve=(r,e,t)=>e in r?he(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var L=(r,e,t)=>(ve(r,typeof e!="symbol"?e+"":e,t),t);const Y=require("process"),y=require("./assets/schema-8e15f296.js"),pe=require("@termius/libfido2"),me=require("@termius/libtermius");require("crypto");require("util");require("net");require("stream");require("os");require("fs");require("http");require("https");require("url");require("zlib");require("tls");require("domain");require("async_hooks");require("child_process");require("path");function de(r){return function(...e){var t=e.pop();return r.call(this,e,t)}}var ye=typeof queueMicrotask=="function"&&queueMicrotask,ne=typeof setImmediate=="function"&&setImmediate,ie=typeof process=="object"&&typeof process.nextTick=="function";function ge(r){setTimeout(r,0)}function we(r){return(e,...t)=>r(()=>e(...t))}var B;ye?B=queueMicrotask:ne?B=setImmediate:ie?B=process.nextTick:B=ge;var C=we(B);function xe(r){return D(r)?function(...e){const t=e.pop(),n=r.apply(this,e);return Z(n,t)}:de(function(e,t){var n;try{n=r.apply(this,e)}catch(i){return t(i)}if(n&&typeof n.then=="function")return Z(n,t);t(null,n)})}function Z(r,e){return r.then(t=>{N(e,null,t)},t=>{N(e,t&&t.message?t:new Error(t))})}function N(r,e,t){try{r(e,t)}catch(n){C(i=>{throw i},n)}}function D(r){return r[Symbol.toStringTag]==="AsyncFunction"}function _e(r){return r[Symbol.toStringTag]==="AsyncGenerator"}function Se(r){return typeof r[Symbol.asyncIterator]=="function"}function g(r){if(typeof r!="function")throw new Error("expected a function");return D(r)?xe(r):r}function c(r,e=r.length){if(!e)throw new Error("arity is undefined");function t(...n){return typeof n[e-1]=="function"?r.apply(this,n):new Promise((i,u)=>{n[e-1]=(s,...f)=>{if(s)return u(s);i(f.length>1?f:f[0])},r.apply(this,n)})}return t}function V(r,e,t,n){e=e||[];var i=[],u=0,s=g(t);return r(e,(f,a,o)=>{var w=u++;s(f,(m,v)=>{i[w]=v,o(m)})},f=>{n(f,i)})}function z(r){return r&&typeof r.length=="number"&&r.length>=0&&r.length%1===0}const Q={};function O(r){function e(...t){if(r!==null){var n=r;r=null,n.apply(this,t)}}return Object.assign(e,r),e}function qe(r){return r[Symbol.iterator]&&r[Symbol.iterator]()}function Ae(r){var e=-1,t=r.length;return function(){return++e<t?{value:r[e],key:e}:null}}function Ie(r){var e=-1;return function(){var n=r.next();return n.done?null:(e++,{value:n.value,key:e})}}function Le(r){var e=r?Object.keys(r):[],t=-1,n=e.length;return function i(){var u=e[++t];return u==="__proto__"?i():t<n?{value:r[u],key:u}:null}}function Ee(r){if(z(r))return Ae(r);var e=qe(r);return e?Ie(e):Le(r)}function E(r){return function(...e){if(r===null)throw new Error("Callback was already called.");var t=r;r=null,t.apply(this,e)}}function ee(r,e,t,n){let i=!1,u=!1,s=!1,f=0,a=0;function o(){f>=e||s||i||(s=!0,r.next().then(({value:v,done:S})=>{if(!(u||i)){if(s=!1,S){i=!0,f<=0&&n(null);return}f++,t(v,a,w),a++,o()}}).catch(m))}function w(v,S){if(f-=1,!u){if(v)return m(v);if(v===!1){i=!0,u=!0;return}if(S===Q||i&&f<=0)return i=!0,n(null);o()}}function m(v){u||(s=!1,i=!0,n(v))}o()}var A=r=>(e,t,n)=>{if(n=O(n),r<=0)throw new RangeError("concurrency limit cannot be less than 1");if(!e)return n(null);if(_e(e))return ee(e,r,t,n);if(Se(e))return ee(e[Symbol.asyncIterator](),r,t,n);var i=Ee(e),u=!1,s=!1,f=0,a=!1;function o(m,v){if(!s)if(f-=1,m)u=!0,n(m);else if(m===!1)u=!0,s=!0;else{if(v===Q||u&&f<=0)return u=!0,n(null);a||w()}}function w(){for(a=!0;f<r&&!u;){var m=i();if(m===null){u=!0,f<=0&&n(null);return}f+=1,t(m.value,m.key,E(o))}a=!1}w()};function Pe(r,e,t,n){return A(e)(r,g(t),n)}var ue=c(Pe,4);function Me(r,e,t){t=O(t);var n=0,i=0,{length:u}=r,s=!1;u===0&&t(null);function f(a,o){a===!1&&(s=!0),s!==!0&&(a?t(a):(++i===u||o===Q)&&t(null))}for(;n<u;n++)e(r[n],n,E(f))}function Oe(r,e,t){return ue(r,1/0,e,t)}function We(r,e,t){var n=z(r)?Me:Oe;return n(r,g(e),t)}var P=c(We,3);function $e(r,e,t){return V(P,r,e,t)}var Te=c($e,3);function Be(r,e,t){return ue(r,1,e,t)}var W=c(Be,3);function Ce(r,e,t){return V(W,r,e,t)}c(Ce,3);class He{constructor(){this.head=this.tail=null,this.length=0}removeLink(e){return e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,e.prev=e.next=null,this.length-=1,e}empty(){for(;this.head;)this.shift();return this}insertAfter(e,t){t.prev=e,t.next=e.next,e.next?e.next.prev=t:this.tail=t,e.next=t,this.length+=1}insertBefore(e,t){t.prev=e.prev,t.next=e,e.prev?e.prev.next=t:this.head=t,e.prev=t,this.length+=1}unshift(e){this.head?this.insertBefore(this.head,e):re(this,e)}push(e){this.tail?this.insertAfter(this.tail,e):re(this,e)}shift(){return this.head&&this.removeLink(this.head)}pop(){return this.tail&&this.removeLink(this.tail)}toArray(){return[...this]}*[Symbol.iterator](){for(var e=this.head;e;)yield e.data,e=e.next}remove(e){for(var t=this.head;t;){var{next:n}=t;e(t)&&this.removeLink(t),t=n}return this}}function re(r,e){r.length=1,r.head=r.tail=e}function Fe(r,e,t){if(e==null)e=1;else if(e===0)throw new RangeError("Concurrency must not be zero");var n=g(r),i=0,u=[];const s={error:[],drain:[],saturated:[],unsaturated:[],empty:[]};function f(l,h){s[l].push(h)}function a(l,h){const d=(...x)=>{o(l,d),h(...x)};s[l].push(d)}function o(l,h){if(!l)return Object.keys(s).forEach(d=>s[d]=[]);if(!h)return s[l]=[];s[l]=s[l].filter(d=>d!==h)}function w(l,...h){s[l].forEach(d=>d(...h))}var m=!1;function v(l,h,d,x){if(x!=null&&typeof x!="function")throw new Error("task callback must be a function");p.started=!0;var _,q;function M(F,...T){if(F)return d?q(F):_();if(T.length<=1)return _(T[0]);_(T)}var X={data:l,callback:d?M:x||M};if(h?p._tasks.unshift(X):p._tasks.push(X),m||(m=!0,C(()=>{m=!1,p.process()})),d||!x)return new Promise((F,T)=>{_=F,q=T})}function S(l){return function(h,...d){i-=1;for(var x=0,_=l.length;x<_;x++){var q=l[x],M=u.indexOf(q);M===0?u.shift():M>0&&u.splice(M,1),q.callback(h,...d),h!=null&&w("error",h,q.data)}i<=p.concurrency-p.buffer&&w("unsaturated"),p.idle()&&w("drain"),p.process()}}function H(l){return l.length===0&&p.idle()?(C(()=>w("drain")),!0):!1}const $=l=>h=>{if(!h)return new Promise((d,x)=>{a(l,(_,q)=>{if(_)return x(_);d(q)})});o(l),f(l,h)};var k=!1,p={_tasks:new He,*[Symbol.iterator](){yield*p._tasks[Symbol.iterator]()},concurrency:e,payload:t,buffer:e/4,started:!1,paused:!1,push(l,h){return Array.isArray(l)?H(l)?void 0:l.map(d=>v(d,!1,!1,h)):v(l,!1,!1,h)},pushAsync(l,h){return Array.isArray(l)?H(l)?void 0:l.map(d=>v(d,!1,!0,h)):v(l,!1,!0,h)},kill(){o(),p._tasks.empty()},unshift(l,h){return Array.isArray(l)?H(l)?void 0:l.map(d=>v(d,!0,!1,h)):v(l,!0,!1,h)},unshiftAsync(l,h){return Array.isArray(l)?H(l)?void 0:l.map(d=>v(d,!0,!0,h)):v(l,!0,!0,h)},remove(l){p._tasks.remove(l)},process(){if(!k){for(k=!0;!p.paused&&i<p.concurrency&&p._tasks.length;){var l=[],h=[],d=p._tasks.length;p.payload&&(d=Math.min(d,p.payload));for(var x=0;x<d;x++){var _=p._tasks.shift();l.push(_),u.push(_),h.push(_.data)}i+=1,p._tasks.length===0&&w("empty"),i===p.concurrency&&w("saturated");var q=E(S(l));n(h,q)}k=!1}},length(){return p._tasks.length},running(){return i},workersList(){return u},idle(){return p._tasks.length+i===0},pause(){p.paused=!0},resume(){p.paused!==!1&&(p.paused=!1,C(p.process))}};return Object.defineProperties(p,{saturated:{writable:!1,value:$("saturated")},unsaturated:{writable:!1,value:$("unsaturated")},empty:{writable:!1,value:$("empty")},drain:{writable:!1,value:$("drain")},error:{writable:!1,value:$("error")}}),p}function ze(r,e,t,n){n=O(n);var i=g(t);return W(r,(u,s,f)=>{i(e,u,(a,o)=>{e=o,f(a)})},u=>n(u,e))}c(ze,4);function Qe(r,e,t,n){return V(A(e),r,t,n)}var se=c(Qe,4);function Re(r,e,t,n){var i=g(t);return se(r,e,(u,s)=>{i(u,(f,...a)=>f?s(f):s(f,a))},(u,s)=>{for(var f=[],a=0;a<s.length;a++)s[a]&&(f=f.concat(...s[a]));return n(u,f)})}var fe=c(Re,4);function be(r,e,t){return fe(r,1/0,e,t)}c(be,3);function ke(r,e,t){return fe(r,1,e,t)}c(ke,3);function I(r,e){return(t,n,i,u)=>{var s=!1,f;const a=g(i);t(n,(o,w,m)=>{a(o,(v,S)=>{if(v||v===!1)return m(v);if(r(S)&&!f)return s=!0,f=e(!0,o),m(null,Q);m()})},o=>{if(o)return u(o);u(null,s?f:e(!1))})}}function Ke(r,e,t){return I(n=>n,(n,i)=>i)(P,r,e,t)}c(Ke,3);function Ue(r,e,t,n){return I(i=>i,(i,u)=>u)(A(e),r,t,n)}c(Ue,4);function je(r,e,t){return I(n=>n,(n,i)=>i)(A(1),r,e,t)}c(je,3);function Ge(r,e,t){t=E(t);var n=g(r),i=g(e),u;function s(a,...o){if(a)return t(a);a!==!1&&(u=o,i(...o,f))}function f(a,o){if(a)return t(a);if(a!==!1){if(!o)return t(null,...u);n(s)}}return f(null,!0)}c(Ge,3);function ae(r){return(e,t,n)=>r(e,n)}function De(r,e,t){return P(r,ae(g(e)),t)}c(De,3);function Ve(r,e,t,n){return A(e)(r,ae(g(t)),n)}var Je=c(Ve,4);function Xe(r,e,t){return Je(r,1,e,t)}var Ye=c(Xe,3);function Ze(r){return D(r)?r:function(...e){var t=e.pop(),n=!0;e.push((...i)=>{n?C(()=>t(...i)):t(...i)}),r.apply(this,e),n=!1}}function Ne(r,e,t){return I(n=>!n,n=>!n)(P,r,e,t)}c(Ne,3);function er(r,e,t,n){return I(i=>!i,i=>!i)(A(e),r,t,n)}c(er,4);function rr(r,e,t){return I(n=>!n,n=>!n)(W,r,e,t)}c(rr,3);function tr(r,e,t,n){var i=new Array(e.length);r(e,(u,s,f)=>{t(u,(a,o)=>{i[s]=!!o,f(a)})},u=>{if(u)return n(u);for(var s=[],f=0;f<e.length;f++)i[f]&&s.push(e[f]);n(null,s)})}function nr(r,e,t,n){var i=[];r(e,(u,s,f)=>{t(u,(a,o)=>{if(a)return f(a);o&&i.push({index:s,value:u}),f(a)})},u=>{if(u)return n(u);n(null,i.sort((s,f)=>s.index-f.index).map(s=>s.value))})}function R(r,e,t,n){var i=z(e)?tr:nr;return i(r,e,g(t),n)}function ir(r,e,t){return R(P,r,e,t)}c(ir,3);function ur(r,e,t,n){return R(A(e),r,t,n)}c(ur,4);function sr(r,e,t){return R(W,r,e,t)}c(sr,3);function fr(r,e){var t=E(e),n=g(Ze(r));function i(u){if(u)return t(u);u!==!1&&n(i)}return i()}c(fr,2);function ar(r,e,t,n){var i=g(t);return se(r,e,(u,s)=>{i(u,(f,a)=>f?s(f):s(f,{key:a,val:u}))},(u,s)=>{for(var f={},{hasOwnProperty:a}=Object.prototype,o=0;o<s.length;o++)if(s[o]){var{key:w}=s[o],{val:m}=s[o];a.call(f,w)?f[w].push(m):f[w]=[m]}return n(u,f)})}c(ar,4);function or(r,e,t,n){n=O(n);var i={},u=g(t);return A(e)(r,(s,f,a)=>{u(s,f,(o,w)=>{if(o)return a(o);i[f]=w,a(o)})},s=>n(s,i))}c(or,4);ie?process.nextTick:ne&&setImmediate;c((r,e,t)=>{var n=z(e)?[]:{};r(e,(i,u,s)=>{g(i)((f,...a)=>{a.length<2&&([a]=a),n[u]=a,s(f)})},i=>t(i,n))},3);function lr(r,e){var t=g(r);return Fe((n,i)=>{t(n[0],i)},e,1)}function cr(r,e){if(e=O(e),!Array.isArray(r))return e(new TypeError("First argument to race must be an array of functions"));if(!r.length)return e();for(var t=0,n=r.length;t<n;t++)g(r[t])(e)}c(cr,2);function J(r,e,t,n){const i=g(t);return R(r,e,(u,s)=>{i(u,(f,a)=>{s(f,!a)})},n)}function hr(r,e,t){return J(P,r,e,t)}c(hr,3);function vr(r,e,t,n){return J(A(e),r,t,n)}c(vr,4);function pr(r,e,t){return J(W,r,e,t)}c(pr,3);function mr(r,e,t){return I(Boolean,n=>n)(P,r,e,t)}c(mr,3);function dr(r,e,t,n){return I(Boolean,i=>i)(A(e),r,t,n)}c(dr,4);function yr(r,e,t){return I(Boolean,n=>n)(W,r,e,t)}c(yr,3);function gr(r,e,t){var n=g(e);return Te(r,(u,s)=>{n(u,(f,a)=>{if(f)return s(f);s(f,{value:u,criteria:a})})},(u,s)=>{if(u)return t(u);t(null,s.sort(i).map(f=>f.value))});function i(u,s){var f=u.criteria,a=s.criteria;return f<a?-1:f>a?1:0}}c(gr,3);function wr(r,e){var t=null,n;return Ye(r,(i,u)=>{g(i)((s,...f)=>{if(s===!1)return u(s);f.length<2?[n]=f:n=f,t=s,u(s?null:{})})},()=>e(t,n))}c(wr);function xr(r,e,t){t=E(t);var n=g(e),i=g(r),u=[];function s(a,...o){if(a)return t(a);u=o,a!==!1&&i(f)}function f(a,o){if(a)return t(a);if(a!==!1){if(!o)return t(null,...u);n(s)}}return i(f)}c(xr,3);function _r(r,e){if(e=O(e),!Array.isArray(r))return e(new Error("First argument to waterfall must be an array of functions"));if(!r.length)return e();var t=0;function n(u){var s=g(r[t++]);s(...u,E(i))}function i(u,...s){if(u!==!1){if(u||t===r.length)return e(u,...s);n(s)}}n([])}c(_r);var Sr=y.rng,qr=y.bytesToUuid_1,te,K,U=0,j=0;function Ar(r,e,t){var n=e&&t||0,i=e||[];r=r||{};var u=r.node||te,s=r.clockseq!==void 0?r.clockseq:K;if(u==null||s==null){var f=Sr();u==null&&(u=te=[f[0]|1,f[1],f[2],f[3],f[4],f[5]]),s==null&&(s=K=(f[6]<<8|f[7])&16383)}var a=r.msecs!==void 0?r.msecs:new Date().getTime(),o=r.nsecs!==void 0?r.nsecs:j+1,w=a-U+(o-j)/1e4;if(w<0&&r.clockseq===void 0&&(s=s+1&16383),(w<0||a>U)&&r.nsecs===void 0&&(o=0),o>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");U=a,j=o,K=s,a+=122192928e5;var m=((a&268435455)*1e4+o)%4294967296;i[n++]=m>>>24&255,i[n++]=m>>>16&255,i[n++]=m>>>8&255,i[n++]=m&255;var v=a/4294967296*1e4&268435455;i[n++]=v>>>8&255,i[n++]=v&255,i[n++]=v>>>24&15|16,i[n++]=v>>>16&255,i[n++]=s>>>8|128,i[n++]=s&255;for(var S=0;S<6;++S)i[n+S]=u[S];return e||qr(i)}var Ir=Ar,Lr=Ir,oe=y.v4_1,le=oe;le.v1=Lr;le.v4=oe;async function Er(r,e,t){try{return await me.winhello.signWithWindowsHelloKey(r,Or(e),t)}catch(n){throw Wr(n)}}class b extends Error{constructor(t){super("Windows Hello is not available on this device");L(this,"name","WindowsHelloUnavailable");this.reason=t}static swallow(t){if(t instanceof b)return t;throw t}}class ce extends Error{constructor(){super("Cancelled by user");L(this,"name","CancelledByUser")}}const Pr=y.lib.z.union([y.lib.z.literal("Webauthn Platform Authenticator not available"),y.lib.z.literal("Error loading webauthn API methods"),y.lib.z.literal("Error loading webauthn.dll"),y.lib.z.literal("Webauthn API version is too old and does not support getPlatformCredentialList API")]),Mr=y.zodGuard(Pr);function Or(r){return Buffer.from(r,"base64")}function Wr(r){return r.message==="The action was cancelled by the user."?new ce:Mr(r.message)?new b(r.message):r}y.registerIpcError(b);y.registerIpcError(ce);class $r{constructor(e){L(this,"signRequestsQueue");L(this,"currentProgress",null);L(this,"queueMessage",async(e,t)=>{this.server.broadcast("sign.progress",this.currentProgress);try{const n=await this.signRequestsQueue.pushAsync(y.BasicSignMessageSchema.passthrough().parse(e));this.server.emit(t,"resolve",n)}catch(n){this.server.emit(t,"reject",y.serializeIpcError(n))}});L(this,"removeFromQueueMessage",(e,t)=>{var i;if(!y.isBasicMessage(e))return;((i=this.currentProgress)==null?void 0:i.id)===e.id||this.signRequestsQueue.remove(({data:u})=>u.id===e.id)});L(this,"consumeMessage",async e=>{this.currentProgress={name:e.name,id:e.id},this.server.broadcast("sign.progress",this.currentProgress);try{return y.isWindowsHelloSignMessage(e)?await this.signWithWindowsHelloKey(e):y.isFidoSignMessage(e)?await this.signWithFidoKey(e):void 0}finally{this.currentProgress=null}});this.server=e,this.signRequestsQueue=lr(this.consumeMessage)}listen(){this.server.on("sign",this.queueMessage),this.server.on("sign.remove",this.removeFromQueueMessage)}stop(){this.server.off("sign",this.queueMessage),this.server.off("sign.remove",this.removeFromQueueMessage)}async signWithFidoKey(e){const{info:{keyHandle:t,data:n,...i}}=e,u={keyHandle:Buffer.from(t.data),data:Buffer.from(n.data),...i};return new Promise(s=>pe.fido2.sign(s,u))}async signWithWindowsHelloKey(e){return Er(Buffer.from(e.data.data),e.credentialId,Buffer.from(e.windowHandle.data))}}y.ipcSingleton.config.retry=30*1e3;y.ipcSingleton.config.socketRoot=Y.argv[Y.argv.length-1];let G=0;y.ipcSingleton.serve(()=>{var e;const r=new $r(y.ipcSingleton.server);r.listen(),y.ipcSingleton.server.on("connect",()=>{G+=1}),y.ipcSingleton.server.on("socket.disconnected",()=>{G-=1,G===0&&(r.stop(),y.ipcSingleton.server.stop(),process.exit())}),(e=process.send)==null||e.call(process,y.ipcSingleton.config.id)});y.ipcSingleton.server.on("error",r=>{y.logger.exception("On start IPC server",r)});y.ipcSingleton.server.start();
//# sourceMappingURL=fido-process.js.map
