import{i as f,p as g,l as P,d as O,P as S}from"./operation-351987c6.js";const m=()=>({initState:t=>({config:t,isStarted:!0}),setCanceled:t=>t.isCancelled=!0,setError:(t,e)=>t.error=e,setResult:(t,e)=>t.result=e,setRunning:t=>t.isStarted=!0,setSucceeded:t=>t.isCompleted=!0,setFailed:()=>{},getError:t=>t.error,getResult:t=>t.result,isCanceled:t=>!!t.isCancelled,isFailed:t=>!!t.error,isRunning:t=>!!t.isStarted,isSucceeded:t=>!!(t.isCompleted&&!t.isCancelled&&!t.error)});class C{constructor(e,s,i,o,n,r,l){this.state=e,this.lro=s,this.setErrorAsResult=i,this.lroResourceLocationConfig=o,this.processResult=n,this.updateState=r,this.isDone=l}setPollerConfig(e){this.pollerConfig=e}async update(e){var s;const i=m();this.state.isStarted||(this.state=Object.assign(Object.assign({},this.state),await f({lro:this.lro,stateProxy:i,resourceLocationConfig:this.lroResourceLocationConfig,processResult:this.processResult,setErrorAsResult:this.setErrorAsResult})));const o=this.updateState,n=this.isDone;return!this.state.isCompleted&&this.state.error===void 0&&await g({lro:this.lro,state:this.state,stateProxy:i,processResult:this.processResult,updateState:o?(r,{rawResponse:l})=>o(r,l):void 0,isDone:n?({flatResponse:r},l)=>n(r,l):void 0,options:e,setDelay:r=>{this.pollerConfig.intervalInMs=r},setErrorAsResult:this.setErrorAsResult}),(s=e==null?void 0:e.fireProgress)===null||s===void 0||s.call(e,this.state),this}async cancel(){return P.error("`cancelOperation` is deprecated because it wasn't implemented"),this}toString(){return JSON.stringify({state:this.state})}}class a extends Error{constructor(e){super(e),this.name="PollerStoppedError",Object.setPrototypeOf(this,a.prototype)}}class c extends Error{constructor(e){super(e),this.name="PollerCancelledError",Object.setPrototypeOf(this,c.prototype)}}class R{constructor(e){this.resolveOnUnsuccessful=!1,this.stopped=!0,this.pollProgressCallbacks=[],this.operation=e,this.promise=new Promise((s,i)=>{this.resolve=s,this.reject=i}),this.promise.catch(()=>{})}async startPolling(e={}){for(this.stopped&&(this.stopped=!1);!this.isStopped()&&!this.isDone();)await this.poll(e),await this.delay()}async pollOnce(e={}){this.isDone()||(this.operation=await this.operation.update({abortSignal:e.abortSignal,fireProgress:this.fireProgress.bind(this)})),this.processUpdatedState()}fireProgress(e){for(const s of this.pollProgressCallbacks)s(e)}async cancelOnce(e={}){this.operation=await this.operation.cancel(e)}poll(e={}){if(!this.pollOncePromise){this.pollOncePromise=this.pollOnce(e);const s=()=>{this.pollOncePromise=void 0};this.pollOncePromise.then(s,s).catch(this.reject)}return this.pollOncePromise}processUpdatedState(){if(this.operation.state.error&&(this.stopped=!0,!this.resolveOnUnsuccessful))throw this.reject(this.operation.state.error),this.operation.state.error;if(this.operation.state.isCancelled&&(this.stopped=!0,!this.resolveOnUnsuccessful)){const e=new c("Operation was canceled");throw this.reject(e),e}this.isDone()&&this.resolve&&this.resolve(this.getResult())}async pollUntilDone(e={}){return this.stopped&&this.startPolling(e).catch(this.reject),this.processUpdatedState(),this.promise}onProgress(e){return this.pollProgressCallbacks.push(e),()=>{this.pollProgressCallbacks=this.pollProgressCallbacks.filter(s=>s!==e)}}isDone(){const e=this.operation.state;return!!(e.isCompleted||e.isCancelled||e.error)}stopPolling(){this.stopped||(this.stopped=!0,this.reject&&this.reject(new a("This poller is already stopped")))}isStopped(){return this.stopped}cancelOperation(e={}){if(!this.cancelPromise)this.cancelPromise=this.cancelOnce(e);else if(e.abortSignal)throw new Error("A cancel request is currently pending");return this.cancelPromise}getOperationState(){return this.operation.state}getResult(){return this.operation.state.result}toString(){return this.operation.toString()}}class y extends R{constructor(e,s){const{intervalInMs:i=S,resumeFrom:o,resolveOnUnsuccessful:n=!1,isDone:r,lroResourceLocationConfig:l,processResult:p,updateState:u}=s||{},d=o?O(o):{},h=new C(d,e,!n,l,p,u,r);super(h),this.resolveOnUnsuccessful=n,this.config={intervalInMs:i},h.setPollerConfig(this.config)}delay(){return new Promise(e=>setTimeout(()=>e(),this.config.intervalInMs))}}export{y as L};
//# sourceMappingURL=lroEngine-9ff87a56.js.map
