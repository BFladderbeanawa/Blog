---
const { post, highlightTags = [] } = Astro.props;

// Formatting Title: Ensure it's clear
const formattedDate = post.data.pubDate.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
});
---
<a href={`/blog/${post.slug}/`} class="post-card" data-slug={post.slug} data-tags={post.data.tags?.join(',') || ''} data-category={post.data.category || ''}>
    
    <div class="hover-overlay-container">
        <div class="hover-bg-gradient"></div>
        <div class="arrows-container">
             <svg class="arrow-shape arrow-inner" viewBox="0 0 24 24" preserveAspectRatio="none">
                <path d="M4,0 L14,12 L4,24 L14,24 L24,12 L14,0 Z" fill="currentColor" />
             </svg>
             <svg class="arrow-shape arrow-outer" viewBox="0 0 24 24" preserveAspectRatio="none">
                <path d="M4,0 L14,12 L4,24 L14,24 L24,12 L14,0 Z" fill="currentColor" />
             </svg>
        </div>
    </div>

    {/* HeroImage removed for list view */}

    <div class="card-content">
        <div class="content-header">
            <h4 class="title">{post.data.title}</h4>
            <div class="compact-meta-wrapper">
                 <time class="date">{formattedDate}</time>
            </div>
        </div>

        <p class="description">{post.data.description}</p>
        
        <div class="meta expanded-only">
            <time class="date">{formattedDate}</time>
            {post.data.category && <span class="category is-hidden-mobile">• {post.data.category}</span>}
        </div>
        
        {/* Tags with Highlighting Logic */}
        {post.data.tags && post.data.tags.length > 0 && (
            <div class="mini-tags">
                {post.data.tags.map((t) => {
                    // Check if this tag is in the 'highlightTags' list
                    const isHigh = highlightTags.includes(t);
                    return (
                        <span class={`mini-tag ${isHigh ? 'highlight' : ''}`}>#{t}</span>
                    );
                })}
            </div>
        )}
        
        <div class="read-more">阅读文章 &rarr;</div>
    </div>
</a>

<script>
    // Client-side script to inject context into the link click
    // This allows the next page to know where we came from
    document.querySelectorAll('.post-card').forEach(card => {
        card.addEventListener('click', (e) => {
            // Determine current context based on URL
            const url = new URL(window.location.href);
            let context = 'all';
            let contextData = '';
            
            if (url.pathname.includes('/category/')) {
                context = 'category';
                // Extract category from URL
                const parts = url.pathname.split('/');
                contextData = parts[parts.indexOf('category') + 1];
            } else if (url.pathname.includes('/tags')) {
                context = 'tags';
                // Tags context is complex (multi-select), so we use the query param
                contextData = url.searchParams.get('tags') || '';
            }

            // Save to sessionStorage for transfer
            sessionStorage.setItem('blog_nav_context', JSON.stringify({
                type: context,
                data: contextData
            }));
        });
    });
</script>

<style>
    /* Default (Expanded) Layout */
    .post-card {
        display: flex;
        flex-direction: column; /* Vertical layout for unified height */
        height: 100%; /* Stretch to fill grid cell */
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        overflow: hidden;
        text-decoration: none;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        margin-bottom: 0; /* Remove bottom margin to let Grid handle gap */
        width: 100%; /* Full width */
        position: relative;
    }
    
    /* Overlay Container - Used for Arrows and Gradient */
    .hover-overlay-container {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        pointer-events: none;
        z-index: 10;
        overflow: hidden;
        /* Ensure it's visible in both modes, but logic differs */
    }

    /* Gradient - Shared Logic, but customized per view if needed */
    .hover-bg-gradient {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        opacity: 0;
        transition: opacity 0.3s ease;
         /* Default (Expanded) Gradient: Subtle Right-to-Left glow */
        background: linear-gradient(to left, 
            rgba(var(--accent), 0.1) 0%, 
            rgba(var(--accent), 0.0) 30%
        );
    }
    .post-card:hover .hover-bg-gradient {
        opacity: 1;
    }

    /* Arrows Container */
    .arrows-container {
        position: absolute;
        top: 0;
        right: 0; /* Align right */
        height: 100%;
        display: flex;
        align-items: center; /* Center vertically */
    }

    /* Arrows - Shared Base Styles */
    .arrow-shape {
        color: rgba(var(--accent), 0.2); /* Lighter color for expanded view by default */
        opacity: 0;
        transform: translateX(100%);
        transition: none; /* Crucial: Prevent transition conflicts with animation */
        /* Default Expanded Size: Smaller, discreet, centered on right */
        height: 80px; /* Specific height for expanded card */
        width: 40px;
    }
    
    .arrow-inner {
        position: absolute;
        right: 70px;
        z-index: 12;
    }
    .arrow-outer {
        position: absolute;
        right: 25px;
        z-index: 13;
    }

    /* Hover Animation - Shared */
    .post-card:hover .arrow-outer {
        animation: slideInOuter 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
    .post-card:hover .arrow-inner {
        animation: slideInInner 0.3s cubic-bezier(0.16, 1, 0.3, 1) 0.08s forwards;
    }

    @keyframes slideInOuter {
        0% { transform: translateX(100%); opacity: 0; }
        100% { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideInInner {
        0% { transform: translateX(100%); opacity: 0; }
        100% { transform: translateX(0); opacity: 1; }
    }


    /* Content Styling */
    .card-image {
        width: 250px;
        flex-shrink: 0;
        overflow: hidden;
        z-index: 2; 
    }
    .card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scale(1.0);
        transition: transform 0.5s ease;
    }
    .post-card:hover .card-image img {
        transform: scale(1.05);
    }

    .card-content {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        z-index: 2; 
        position: relative;
    }
    
    .content-header {
        display: block;
    }
    
    .compact-meta-wrapper {
        display: none; /* Hidden in expanded */
    }

    .title {
        margin: 0 0 0.5rem 0;
        color: var(--heading-color);
        font-size: 1.5rem;
        transition: color 0.2s ease;
    }

    .description {
        margin: 0 0 1rem 0;
        color: var(--text-color);
        font-size: 0.95rem;
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .meta {
        display: flex;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: rgb(var(--gray));
        margin-bottom: 0.5rem;
    }

    .mini-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: auto;
        padding-top: 1rem;
    }
    .mini-tag {
        font-size: 0.75rem;
        color: rgb(var(--gray));
        background: rgba(0,0,0,0.03);
        padding: 2px 6px;
        border-radius: 4px;
    }
    .mini-tag.highlight {
        background: rgba(var(--accent), 0.15);
        color: rgb(var(--accent));
        font-weight: bold;
    }

    .read-more {
        margin-top: 1rem;
        font-size: 0.9rem;
        font-weight: bold;
        color: var(--heading-color);
        display: flex;
        align-items: center;
        gap: 0.3rem;
        transition: gap 0.2s ease;
    }
    
    .post-card:hover .read-more {
        gap: 0.6rem;
        color: rgb(var(--accent));
    }
    
    /* --------------------------------------------------------- */
    /* COMPACT VIEW STYLES - Specific Overrides */
    /* --------------------------------------------------------- */
    
    :global(.post-grid.compact-view) {
        grid-template-columns: 1fr !important;
        gap: 0.8rem !important;
    }

    :global(.compact-view) .post-card {
        flex-direction: row;
        align-items: center;
        height: 64px;
        margin-bottom: 0;
        border: 1px solid transparent; 
        border-bottom: 1px solid var(--border-color);
        border-radius: 0;
        background: transparent;
        transition: background-color 0.2s ease, border-color 0.2s ease; /* Removed 'all' to prevent layout transitions */
    }
    
    :global(.compact-view) .post-card:hover {
        background: transparent;
        z-index: 10;
    }

    /* COMPACT: Gradient Override */
    :global(.compact-view) .hover-bg-gradient {
        /* Gradient sweeping from Right to Left for compact */
        background: linear-gradient(to left, 
            rgba(var(--accent), 0.15) 0%, 
            rgba(var(--accent), 0.05) 30%, 
            rgba(var(--accent), 0.0) 70%
        );
        border: 1px solid rgba(var(--accent), 0.1);
        border-right: 3px solid rgba(var(--accent), 0.4); 
    }

    /* COMPACT: Arrows Override (Full Height) */
    :global(.compact-view) .arrow-shape {
        height: 100%;
        width: 40px; 
        color: rgb(var(--accent)); /* Restore full color for compact view */
    }
    
    /* COMPACT: Keep arrows full right as originally designed for compact view */
    :global(.compact-view) .arrow-inner {
        right: 45px;
    }
    :global(.compact-view) .arrow-outer {
        right: 0px; 
    }

    /* COMPACT: Hide Elements */
    :global(.compact-view) .card-image,
    :global(.compact-view) .description,
    :global(.compact-view) .read-more,
    :global(.compact-view) .expanded-only,
    :global(.compact-view) .mini-tags {
        display: none !important;
    }

    /* COMPACT: Adjust Content */
    :global(.compact-view) .card-content {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 0 1.5rem;
        width: 100%;
    }
    
    :global(.compact-view) .content-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        position: relative; /* Context for date movement */
    }

    :global(.compact-view) .title {
        font-size: 1.1rem;
        margin: 0;
        z-index: 3;
    }
    
    :global(.compact-view) .compact-meta-wrapper {
        display: block;
        font-size: 0.9rem;
        color: rgb(var(--gray));
        z-index: 3;
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    /* COMPACT: Date Movement */
    :global(.compact-view) .post-card:hover .compact-meta-wrapper {
        transform: translateX(-90px);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .post-card {
            flex-direction: column;
        }
        .card-image {
            width: 100%;
            height: 200px;
        }
        
        /* Compact Responsive */
        :global(.compact-view) .post-card {
            height: auto;
            padding: 0.8rem 0;
        }
        :global(.compact-view) .content-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.4rem;
        }
    }

    /* Dark Mode */
    :global(html[data-theme='nord']) .mini-tag {
        background: rgba(255,255,255,0.05);
        color: var(--text-color);
    }
    :global(html[data-theme='nord']) .mini-tag.highlight {
        background: rgba(136, 192, 208, 0.2);
        color: #88c0d0;
    }
    
    /* Dark Mode Date/Meta Fix */
    :global(html[data-theme='nord']) .meta,
    :global(html[data-theme='nord']) :global(.compact-view) .compact-meta-wrapper {
        color: rgba(255, 255, 255, 0.7) !important;
    }
</style>
