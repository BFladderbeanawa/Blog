---
const { tags, currentCategory } = Astro.props;
const currentPath = Astro.url.pathname;
const isAllPosts = currentPath === '/blog' || currentPath === '/blog/';
const isCategory = currentPath.startsWith('/category');
const isTags = currentPath.startsWith('/tags');

// Only show toggle on list pages, not on individual blog posts
// The logic: if it's NOT a specific post page.
// Blog pages start with /blog/[slug], so we check if it is exactly /blog, or category/tag pages.
const showToggle = isAllPosts || isCategory || isTags;
---
<nav class="blog-nav">
    <div class="nav-content">
        <span class="nav-label">浏览:</span>
        <a href="/blog" class={`nav-link ${isAllPosts ? 'active' : ''}`}>全部文章</a>
        <a href="/category" class={`nav-link ${isCategory ? 'active' : ''}`}>分类</a>
        <a href="/tags" class={`nav-link ${isTags ? 'active' : ''}`}>标签云</a>
        
        {currentCategory && (
            <div class="current-item">
                <span class="sep">|</span>
                <span class="nav-label">当前分类:</span>
                <span class="item-badge">{currentCategory}</span>
            </div>
        )}

        {tags && tags.length > 0 && (
            <div class="current-tags">
                <span class="sep">|</span>
                <span class="nav-label">当前标签:</span>
                {tags.map(t => <span class="tag-badge">#{t}</span>)}
            </div>
        )}
    </div>

    <!-- View Toggle -->
    {showToggle && (
        <div class="view-toggle">
            <div class="glider"></div>
            <button id="view-expanded" class="toggle-btn active" title="详细视图" aria-label="详细视图">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                </svg>
            </button>
            <button id="view-compact" class="toggle-btn" title="紧凑视图" aria-label="紧凑视图">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
            </button>
        </div>
    )}
</nav>

<script>
    document.addEventListener('astro:page-load', () => {
        const btnExpanded = document.getElementById('view-expanded');
        const btnCompact = document.getElementById('view-compact');
        const gridContainer = document.querySelector('.post-grid');
        
        let currentMode = localStorage.getItem('blog_view_mode') || 'expanded';
        
        // Initial setup (instant)
        if (gridContainer) {
            // Apply initial state without animation
            updateClasses(currentMode);
            // Match the CSS transition duration (0.3s)
            gridContainer.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            
            // Wait for JS to stabilize layout, then trigger entrance animation
            requestAnimationFrame(() => {
                gridContainer.classList.add('animate-in');
            });
        }

        function updateClasses(mode) {
           // Update slider state
           const viewToggle = document.querySelector('.view-toggle');
           if (viewToggle) viewToggle.setAttribute('data-mode', mode);

           if (mode === 'compact') {
                gridContainer.classList.add('compact-view');
                btnCompact?.classList.add('active');
                btnExpanded?.classList.remove('active');
            } else {
                gridContainer.classList.remove('compact-view');
                btnExpanded?.classList.add('active');
                btnCompact?.classList.remove('active');
            }
        }

        function setMode(mode) {
            if (!gridContainer) return;
            if (mode === currentMode) return;
            
            // Ensure transition is active and duration matches logic
            gridContainer.style.transition = 'opacity 0.3s ease, transform 0.3s ease';

            // Simple Opacity Fade for cleaner transition
            gridContainer.style.opacity = '0';
            gridContainer.style.transform = 'translateY(10px)';
            
            // Wait for fade-out to complete (350ms > 300ms transition to be safe)
            setTimeout(() => {
                updateClasses(mode);
                currentMode = mode;
                localStorage.setItem('blog_view_mode', mode);

                // Reveal
                requestAnimationFrame(() => {
                    gridContainer.style.opacity = '1';
                    gridContainer.style.transform = 'translateY(0)';
                });
            }, 350);
        }

        btnExpanded?.addEventListener('click', () => setMode('expanded'));
        btnCompact?.addEventListener('click', () => setMode('compact'));
    });
</script>

<style>
    .blog-nav {
        /* Sticky Positioning for Stacked Navbar Effect */
        position: sticky;
        top: 0;
        z-index: 40; /* Below Header (usually 50) but above content */
        
        margin-bottom: 2rem;
        padding: 0.8rem 1rem;
        background: var(--card-bg); /* Use theme variable */
        border-bottom: 1px solid var(--border-color); /* Separator */
        /* Remove full border and radius to make it look like a bar */
        border-top: none;
        border-left: none;
        border-right: none;
        border-radius: 0;
        
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); /* Shadow to float over content */
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: nowrap; /* Prevent wrapping on desktop */
        gap: 1rem;
    }
    .nav-content {
        display: flex;
        align-items: center;
        gap: 1rem;
        white-space: nowrap;
        overflow-x: auto;
        /* Ensure it takes available space but allows scrolling */
        flex: 1;
        min-width: 0;
        scrollbar-width: thin; /* Make scrollbar less intrusive */
    }
    
    .view-toggle {
        flex-shrink: 0;
        display: flex;
        gap: 0;
        background: var(--gray-light);
        padding: 4px;
        border-radius: 8px;
        position: relative;
        isolation: isolate;
    }

    .glider {
        position: absolute;
        top: 4px;
        left: 4px;
        width: 32px;
        height: 32px;
        background: var(--card-bg);
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        z-index: 1;
        pointer-events: none;
    }
    
    /* Move glider based on state */
    .view-toggle[data-mode='compact'] .glider {
        transform: translateX(100%);
    }

    .toggle-btn {
        background: none;
        border: none;
        width: 32px;
        height: 32px;
        padding: 0;
        border-radius: 6px;
        cursor: pointer;
        color: var(--gray);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.3s ease;
        position: relative;
        z-index: 2;
    }
    .toggle-btn:hover {
        color: var(--heading-color);
    }
    .toggle-btn.active {
        /* background: var(--card-bg); handled by glider */
        color: rgb(var(--accent));
        /* box-shadow: 0 2px 5px rgba(0,0,0,0.1); handled by glider */
    }
    
    /* Dark mode */
    :global(html[data-theme='nord']) .tag-badge {
        background: rgba(255,255,255,0.1);
    }
</style>
